<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>云南鲜切花产量地图1</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
    }
    .legend-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .legend-bar {
      display: flex;
      width: 80%;
      height: 20px;
      border-radius: 5px;
      overflow: hidden;
    }
    .legend-bar div {
      height: 100%;
      flex-grow: 1;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 20px;
    }
    .tooltip {
      position: absolute;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      opacity: 0;
    }
  </style>
</head>
<body>

  <h1>云南鲜切花产量地图1</h1>
  <svg></svg>
  <div class="legend-container">
    <div class="legend-bar" id="legend"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const width = 1000, height = 800;

    const svg = d3.select("svg")
      .attr("viewBox", `0 0 ${width} ${height}`);

    Promise.all([
      d3.json("云南省1_530000_full.json"),
      d3.csv("fresh cut flower1( million branches.csv")
    ]).then(([geoData, csvData]) => {
      // 合并产量数据到地图数据
      geoData.features.forEach(feature => {
        const cityData = csvData.find(row => row.city === feature.properties.name);
        feature.properties.production = cityData ? +cityData["Fresh Cut Flowers"] : 0;
      });

      const projection = d3.geoMercator()
        .fitExtent([[20, 20], [980, 780]], geoData);

      const path = d3.geoPath().projection(projection);

      const maxProduction = d3.max(geoData.features, d => d.properties.production);
      const colorScale = d3.scaleLinear()
        .domain([0, maxProduction])
        .range(["#f0f9e8", "#0868ac"]);

      // 绘制地图
      svg.selectAll("path")
        .data(geoData.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("stroke", "#000")
        .attr("stroke-width", 0.5)
        .attr("fill", d => colorScale(d.properties.production))
        .on("mouseover", (event, d) => {
          d3.select(".tooltip")
            .style("opacity", 0.9)
            .html(`${d.properties.name}<br>产量: ${d.properties.production} 万支`)
            .style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY + 10}px`);
        })
        .on("mouseout", () => {
          d3.select(".tooltip").style("opacity", 0);
        });

      // 添加工具提示
      d3.select("body").append("div")
        .attr("class", "tooltip");

      // 绘制图例
      const legend = d3.select("#legend");
      const legendValues = d3.range(0, maxProduction, maxProduction / 10);

      legend.selectAll("div")
        .data(legendValues)
        .enter()
        .append("div")
        .style("background-color", d => colorScale(d))
        .style("flex-grow", 1)
        .text(d => Math.round(d));

    }).catch(error => console.error(error));
  </script>

</body>
</html>

